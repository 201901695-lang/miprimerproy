// Sistema de Inventario - Ferreter√≠a Pro
class InventoryManager {
    constructor() {
        this.items = JSON.parse(localStorage.getItem('inventoryItems')) || [];
        this.currentSection = 'dashboard';
        this.editingItem = null;
        this.init();
    }

    init() {
        this.setupEventListeners();
        this.updateDateTime();
        this.loadSampleData();
        this.renderInventory();
        this.updateDashboard();
        this.updateReports();
        
        // Update date/time every second
        setInterval(() => this.updateDateTime(), 1000);
    }

    setupEventListeners() {
        // Navigation
        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const section = e.currentTarget.dataset.section;
                this.switchSection(section);
            });
        });

        // Form submission
        document.getElementById('addItemForm').addEventListener('submit', (e) => {
            e.preventDefault();
            this.handleFormSubmit();
        });

        // Reset form
        document.getElementById('resetForm').addEventListener('click', () => {
            this.resetForm();
        });

        // Image upload
        document.getElementById('itemImage').addEventListener('change', (e) => {
            this.handleImageUpload(e);
        });

        // Search and filters
        document.getElementById('searchInput').addEventListener('input', () => {
            this.filterInventory();
        });

        document.getElementById('categoryFilter').addEventListener('change', () => {
            this.filterInventory();
        });

        document.getElementById('stockFilter').addEventListener('change', () => {
            this.filterInventory();
        });

        // Export functions
        document.getElementById('exportExcel').addEventListener('click', () => {
            this.exportToExcel();
        });

        document.getElementById('exportPDF').addEventListener('click', () => {
            this.exportToPDF();
        });

        document.getElementById('printReport').addEventListener('click', () => {
            this.printReport();
        });

        // Modal close
        document.querySelector('.close').addEventListener('click', () => {
            this.closeModal();
        });

        window.addEventListener('click', (e) => {
            if (e.target === document.getElementById('itemModal')) {
                this.closeModal();
            }
        });
    }

    switchSection(section) {
        // Update navigation
        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        document.querySelector(`[data-section="${section}"]`).classList.add('active');

        // Update sections
        document.querySelectorAll('.section').forEach(sec => {
            sec.classList.remove('active');
        });
        document.getElementById(section).classList.add('active');

        this.currentSection = section;

        // Update data when switching sections
        if (section === 'dashboard') {
            this.updateDashboard();
        } else if (section === 'reports') {
            this.updateReports();
        }
    }

    updateDateTime() {
        const now = new Date();
        const options = { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        };
        document.getElementById('currentDateTime').textContent = 
            now.toLocaleDateString('es-ES', options);
    }

    loadSampleData() {
        if (this.items.length === 0) {
            // Load sample data for demonstration
            const sampleItems = [
                {
                    id: Date.now() + 1,
                    name: 'Martillo de Carpintero',
                    category: 'herramientas',
                    quantity: 25,
                    price: 45.99,
                    minStock: 10,
                    purchaseDate: '2024-01-15',
                    supplier: 'Herramientas Pro S.A.',
                    description: 'Martillo de carpintero profesional con mango de madera',
                    image: 'https://picsum.photos/seed/martillo/300/200.jpg'
                },
                {
                    id: Date.now() + 2,
                    name: 'Taladro El√©ctrico',
                    category: 'herramientas',
                    quantity: 8,
                    price: 125.50,
                    minStock: 5,
                    purchaseDate: '2024-02-01',
                    supplier: 'Bosch Tools',
                    description: 'Taladro el√©ctrico inal√°mbrico 18V',
                    image: 'https://picsum.photos/seed/taladro/300/200.jpg'
                },
                {
                    id: Date.now() + 3,
                    name: 'Cemento Portland',
                    category: 'materiales',
                    quantity: 150,
                    price: 12.75,
                    minStock: 50,
                    purchaseDate: '2024-01-20',
                    supplier: 'ConstruCemento',
                    description: 'Cemento Portland gris 50kg',
                    image: 'https://picsum.photos/seed/cemento/300/200.jpg'
                },
                {
                    id: Date.now() + 4,
                    name: 'Cable El√©ctrico 12AWG',
                    category: 'electricidad',
                    quantity: 3,
                    price: 8.99,
                    minStock: 10,
                    purchaseDate: '2024-02-10',
                    supplier: 'ElectricSupply',
                    description: 'Cable el√©ctrico THW 12AWG',
                    image: 'https://picsum.photos/seed/cable/300/200.jpg'
                }
            ];
            
            this.items = sampleItems;
            this.saveToLocalStorage();
        }
    }

    saveToLocalStorage() {
        localStorage.setItem('inventoryItems', JSON.stringify(this.items));
    }

    handleFormSubmit() {
        const formData = {
            id: this.editingItem ? this.editingItem.id : Date.now(),
            name: document.getElementById('itemName').value,
            category: document.getElementById('itemCategory').value,
            quantity: parseInt(document.getElementById('itemQuantity').value),
            price: parseFloat(document.getElementById('itemPrice').value),
            minStock: parseInt(document.getElementById('itemMinStock').value),
            purchaseDate: document.getElementById('purchaseDate').value,
            supplier: document.getElementById('itemSupplier').value,
            description: document.getElementById('itemDescription').value,
            image: document.getElementById('imagePreview').dataset.image || 'https://picsum.photos/seed/default/300/200.jpg'
        };

        if (this.editingItem) {
            // Update existing item
            const index = this.items.findIndex(item => item.id === this.editingItem.id);
            this.items[index] = formData;
            this.showToast('Producto actualizado correctamente', 'success');
        } else {
            // Add new item
            this.items.push(formData);
            this.showToast('Producto agregado correctamente', 'success');
        }

        this.saveToLocalStorage();
        this.resetForm();
        this.renderInventory();
        this.updateDashboard();
        this.updateReports();
        
        // Switch to inventory section to see the new item
        this.switchSection('inventory');
    }

    resetForm() {
        document.getElementById('addItemForm').reset();
        document.getElementById('imagePreview').innerHTML = `
            <i class="fas fa-camera"></i>
            <span>Click para subir imagen</span>
        `;
        document.getElementById('imagePreview').dataset.image = '';
        this.editingItem = null;
    }

    handleImageUpload(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const imageUrl = e.target.result;
                document.getElementById('imagePreview').innerHTML = `
                    <img src="${imageUrl}" alt="Preview" style="max-width: 100%; max-height: 100%; object-fit: cover;">
                `;
                document.getElementById('imagePreview').dataset.image = imageUrl;
            };
            reader.readAsDataURL(file);
        }
    }

    renderInventory() {
        const grid = document.getElementById('inventoryGrid');
        const filteredItems = this.getFilteredItems();
        
        if (filteredItems.length === 0) {
            grid.innerHTML = `
                <div style="grid-column: 1 / -1; text-align: center; padding: 3rem;">
                    <i class="fas fa-box-open" style="font-size: 3rem; color: var(--text-secondary); margin-bottom: 1rem;"></i>
                    <p style="color: var(--text-secondary);">No hay productos para mostrar</p>
                </div>
            `;
            return;
        }

        grid.innerHTML = filteredItems.map(item => this.createItemCard(item)).join('');
        
        // Add click event listeners to item cards
        document.querySelectorAll('.item-card').forEach(card => {
            card.addEventListener('click', (e) => {
                if (!e.target.closest('.item-actions')) {
                    const itemId = parseInt(card.dataset.itemId);
                    this.showItemDetails(itemId);
                }
            });
        });

        // Add action button event listeners
        document.querySelectorAll('.edit-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const itemId = parseInt(btn.dataset.itemId);
                this.editItem(itemId);
            });
        });

        document.querySelectorAll('.delete-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const itemId = parseInt(btn.dataset.itemId);
                this.deleteItem(itemId);
            });
        });
    }

    createItemCard(item) {
        const stockStatus = this.getStockStatus(item.quantity, item.minStock);
        
        return `
            <div class="item-card" data-item-id="${item.id}">
                <div class="item-image">
                    ${item.image ? 
                        `<img src="${item.image}" alt="${item.name}" style="width: 100%; height: 100%; object-fit: cover;">` :
                        '<i class="fas fa-box"></i>'
                    }
                </div>
                <div class="item-details">
                    <div class="item-name">${item.name}</div>
                    <div class="item-category">${this.getCategoryLabel(item.category)}</div>
                    
                    <div class="item-quantity">
                        <span class="quantity-label">Stock:</span>
                        <span class="quantity-value">${item.quantity} unidades</span>
                    </div>
                    
                    <div class="item-price">
                        <span class="price-label">Precio:</span>
                        <span class="price-value">$${item.price.toFixed(2)}</span>
                    </div>
                    
                    <div class="stock-status stock-${stockStatus}">
                        ${this.getStockStatusLabel(stockStatus)}
                    </div>
                    
                    <div class="item-actions" style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                        <button class="btn-secondary edit-btn" data-item-id="${item.id}" style="flex: 1; padding: 0.5rem;">
                            <i class="fas fa-edit"></i> Editar
                        </button>
                        <button class="btn-secondary delete-btn" data-item-id="${item.id}" style="flex: 1; padding: 0.5rem; background: #fef2f2; color: var(--danger-color); border-color: var(--danger-color);">
                            <i class="fas fa-trash"></i> Eliminar
                        </button>
                    </div>
                </div>
            </div>
        `;
    }

    getStockStatus(quantity, minStock) {
        if (quantity <= minStock) return 'low';
        if (quantity <= minStock * 2) return 'medium';
        return 'high';
    }

    getStockStatusLabel(status) {
        const labels = {
            low: '‚ö†Ô∏è Stock Bajo',
            medium: 'üìä Stock Medio',
            high: '‚úÖ Stock Alto'
        };
        return labels[status] || 'Stock Normal';
    }

    getCategoryLabel(category) {
        const labels = {
            herramientas: 'üîß Herramientas',
            materiales: 'üèóÔ∏è Materiales',
            electricidad: '‚ö° Electricidad',
            fontaner√≠a: 'üö∞ Fontaner√≠a',
            pintura: 'üé® Pintura',
            otros: 'üì¶ Otros'
        };
        return labels[category] || category;
    }

    getFilteredItems() {
        let filtered = [...this.items];
        
        // Search filter
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        if (searchTerm) {
            filtered = filtered.filter(item => 
                item.name.toLowerCase().includes(searchTerm) ||
                item.description.toLowerCase().includes(searchTerm) ||
                item.supplier.toLowerCase().includes(searchTerm)
            );
        }
        
        // Category filter
        const categoryFilter = document.getElementById('categoryFilter').value;
        if (categoryFilter) {
            filtered = filtered.filter(item => item.category === categoryFilter);
        }
        
        // Stock filter
        const stockFilter = document.getElementById('stockFilter').value;
        if (stockFilter) {
            filtered = filtered.filter(item => {
                const status = this.getStockStatus(item.quantity, item.minStock);
                return status === stockFilter;
            });
        }
        
        return filtered;
    }

    filterInventory() {
        this.renderInventory();
    }

    showItemDetails(itemId) {
        const item = this.items.find(i => i.id === itemId);
        if (!item) return;

        const modalBody = document.getElementById('modalBody');
        modalBody.innerHTML = `
            <div style="text-align: center;">
                ${item.image ? 
                    `<img src="${item.image}" alt="${item.name}" style="max-width: 100%; max-height: 300px; object-fit: cover; border-radius: 0.5rem; margin-bottom: 1rem;">` :
                    '<div style="width: 100%; height: 200px; background: var(--light-color); display: flex; align-items: center; justify-content: center; border-radius: 0.5rem; margin-bottom: 1rem;"><i class="fas fa-box" style="font-size: 3rem; color: var(--text-secondary);"></i></div>'
                }
            </div>
            
            <h2 style="margin-bottom: 1rem; color: var(--dark-color);">${item.name}</h2>
            
            <div style="display: grid; gap: 1rem;">
                <div style="display: flex; justify-content: space-between; padding: 0.75rem; background: var(--light-color); border-radius: 0.5rem;">
                    <span style="color: var(--text-secondary);">Categor√≠a:</span>
                    <span style="font-weight: 600;">${this.getCategoryLabel(item.category)}</span>
                </div>
                
                <div style="display: flex; justify-content: space-between; padding: 0.75rem; background: var(--light-color); border-radius: 0.5rem;">
                    <span style="color: var(--text-secondary);">Cantidad:</span>
                    <span style="font-weight: 600;">${item.quantity} unidades</span>
                </div>
                
                <div style="display: flex; justify-content: space-between; padding: 0.75rem; background: var(--light-color); border-radius: 0.5rem;">
                    <span style="color: var(--text-secondary);">Precio Unitario:</span>
                    <span style="font-weight: 600; color: var(--success-color);">$${item.price.toFixed(2)}</span>
                </div>
                
                <div style="display: flex; justify-content: space-between; padding: 0.75rem; background: var(--light-color); border-radius: 0.5rem;">
                    <span style="color: var(--text-secondary);">Valor Total:</span>
                    <span style="font-weight: 600; color: var(--success-color);">$${(item.quantity * item.price).toFixed(2)}</span>
                </div>
                
                <div style="display: flex; justify-content: space-between; padding: 0.75rem; background: var(--light-color); border-radius: 0.5rem;">
                    <span style="color: var(--text-secondary);">Stock M√≠nimo:</span>
                    <span style="font-weight: 600;">${item.minStock} unidades</span>
                </div>
                
                <div style="display: flex; justify-content: space-between; padding: 0.75rem; background: var(--light-color); border-radius: 0.5rem;">
                    <span style="color: var(--text-secondary);">Fecha de Compra:</span>
                    <span style="font-weight: 600;">${new Date(item.purchaseDate).toLocaleDateString('es-ES')}</span>
                </div>
                
                <div style="display: flex; justify-content: space-between; padding: 0.75rem; background: var(--light-color); border-radius: 0.5rem;">
                    <span style="color: var(--text-secondary);">Proveedor:</span>
                    <span style="font-weight: 600;">${item.supplier || 'No especificado'}</span>
                </div>
                
                <div style="padding: 0.75rem; background: var(--light-color); border-radius: 0.5rem;">
                    <div style="color: var(--text-secondary); margin-bottom: 0.5rem;">Descripci√≥n:</div>
                    <div style="font-weight: 400;">${item.description || 'Sin descripci√≥n'}</div>
                </div>
            </div>
            
            <div style="margin-top: 2rem; display: flex; gap: 1rem;">
                <button class="btn-primary" onclick="inventoryManager.editItem($item.id)" style="flex: 1;">
                    <i class="fas fa-edit"></i> Editar
                </button>
                <button class="btn-secondary" onclick="inventoryManager.deleteItem($item.id)" style="flex: 1; background: #fef2f2; color: var(--danger-color); border-color: var(--danger-color);">
                    <i class="fas fa-trash"></i> Eliminar
                </button>
            </div>
        `;

        document.getElementById('itemModal').style.display = 'block';
    }

    closeModal() {
        document.getElementById('itemModal').style.display = 'none';
    }

    editItem(itemId) {
        const item = this.items.find(i => i.id === itemId);
        if (!item) return;

        this.editingItem = item;
        
        // Fill form with item data
        document.getElementById('itemName').value = item.name;
        document.getElementById('itemCategory').value = item.category;
        document.getElementById('itemQuantity').value = item.quantity;
        document.getElementById('itemPrice').value = item.price;
        document.getElementById('itemMinStock').value = item.minStock;
        document.getElementById('purchaseDate').value = item.purchaseDate;
        document.getElementById('itemSupplier').value = item.supplier || '';
        document.getElementById('itemDescription').value = item.description || '';
        
        if (item.image) {
            document.getElementById('imagePreview').innerHTML = `
                <img src="${item.image}" alt="Preview" style="max-width: 100%; max-height: 100%; object-fit: cover;">
            `;
            document.getElementById('imagePreview').dataset.image = item.image;
        }

        this.closeModal();
        this.switchSection('add-item');
        
        // Scroll to top
        window.scrollTo(0, 0);
    }

    deleteItem(itemId) {
        if (confirm('¬øEst√°s seguro de que deseas eliminar este producto? Esta acci√≥n no se puede deshacer.')) {
            this.items = this.items.filter(item => item.id !== itemId);
            this.saveToLocalStorage();
            this.renderInventory();
            this.updateDashboard();
            this.updateReports();
            this.showToast('Producto eliminado correctamente', 'success');
            this.closeModal();
        }
    }

    updateDashboard() {
        const totalItems = this.items.length;
        const totalQuantity = this.items.reduce((sum, item) => sum + item.quantity, 0);
        const lowStockItems = this.items.filter(item => item.quantity <= item.minStock).length;
        const totalValue = this.items.reduce((sum, item) => sum + (item.quantity * item.price), 0);

        document.getElementById('totalItems').textContent = totalItems;
        document.getElementById('totalQuantity').textContent = totalQuantity;
        document.getElementById('lowStock').textContent = lowStockItems;
        document.getElementById('totalValue').textContent = `$${totalValue.toFixed(2)}`;

        // Update recent activity
        const recentActivity = document.getElementById('recentActivityList');
        const recentItems = [...this.items]
            .sort((a, b) => new Date(b.purchaseDate) - new Date(a.purchaseDate))
            .slice(0, 5);

        if (recentItems.length === 0) {
            recentActivity.innerHTML = '<p style="color: var(--text-secondary);">No hay actividad reciente</p>';
        } else {
            recentActivity.innerHTML = recentItems.map(item => `
                <div style="padding: 0.75rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-weight: 600;">${item.name}</div>
                        <div style="color: var(--text-secondary); font-size: 0.875rem;">
                            ${this.getCategoryLabel(item.category)} ‚Ä¢ ${item.quantity} unidades
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-weight: 600; color: var(--success-color);">$${(item.quantity * item.price).toFixed(2)}</div>
                        <div style="color: var(--text-secondary); font-size: 0.875rem;">
                            ${new Date(item.purchaseDate).toLocaleDateString('es-ES')}
                        </div>
                    </div>
                </div>
            `).join('');
        }
    }

    updateReports() {
        // Low stock report
        const lowStockItems = this.items.filter(item => item.quantity <= item.minStock);
        const lowStockReport = document.getElementById('lowStockReport');
        
        if (lowStockItems.length === 0) {
            lowStockReport.innerHTML = '<p style="color: var(--success-color);">‚úÖ Todos los productos tienen stock adecuado</p>';
        } else {
            lowStockReport.innerHTML = lowStockItems.map(item => `
                <div style="padding: 0.75rem; border-left: 4px solid var(--danger-color); margin-bottom: 0.5rem; background: #fef2f2;">
                    <div style="font-weight: 600;">${item.name}</div>
                    <div style="color: var(--text-secondary); font-size: 0.875rem;">
                        Stock actual: ${item.quantity} / M√≠nimo: ${item.minStock}
                    </div>
                </div>
            `).join('');
        }

        // Category report
        const categoryReport = document.getElementById('categoryReport');
        const categories = {};
        
        this.items.forEach(item => {
            if (!categories[item.category]) {
                categories[item.category] = {
                    count: 0,
                    quantity: 0,
                    value: 0
                };
            }
            categories[item.category].count++;
            categories[item.category].quantity += item.quantity;
            categories[item.category].value += item.quantity * item.price;
        });

        categoryReport.innerHTML = Object.entries(categories).map(([category, data]) => `
            <div style="padding: 0.75rem; border-bottom: 1px solid var(--border-color);">
                <div style="font-weight: 600;">${this.getCategoryLabel(category)}</div>
                <div style="color: var(--text-secondary); font-size: 0.875rem; margin-top: 0.25rem;">
                    ${data.count} productos ‚Ä¢ ${data.quantity} unidades ‚Ä¢ Valor: $${data.value.toFixed(2)}
                </div>
            </div>
        `).join('');

        // Movement report (simplified - shows recent additions)
        const movementReport = document.getElementById('movementReport');
        const recentItems = [...this.items]
            .sort((a, b) => new Date(b.purchaseDate) - new Date(a.purchaseDate))
            .slice(0, 10);

        if (recentItems.length === 0) {
            movementReport.innerHTML = '<p style="color: var(--text-secondary);">No hay movimientos registrados</p>';
        } else {
            movementReport.innerHTML = recentItems.map(item => `
                <div style="padding: 0.75rem; border-bottom: 1px solid var(--border-color);">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: 600;">${item.name}</div>
                            <div style="color: var(--text-secondary); font-size: 0.875rem;">
                                ${item.quantity} unidades ‚Ä¢ $${item.price.toFixed(2)} c/u
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-weight: 600; color: var(--success-color);">$${(item.quantity * item.price).toFixed(2)}</div>
                            <div style="color: var(--text-secondary); font-size: 0.875rem;">
                                ${new Date(item.purchaseDate).toLocaleDateString('es-ES')}
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }
    }

    exportToExcel() {
        let csvContent = "data:text/csv;charset=utf-8,";
        csvContent += "Nombre,Categor√≠a,Cantidad,Precio Unitario,Precio Total,Stock M√≠nimo,Proveedor,Fecha de Compra\n";
        
        this.items.forEach(item => {
            const row = [
                item.name,
                item.category,
                item.quantity,
                item.price.toFixed(2),
                (item.quantity * item.price).toFixed(2),
                item.minStock,
                item.supplier || '',
                new Date(item.purchaseDate).toLocaleDateString('es-ES')
            ].map(field => `"${field}"`).join(',');
            csvContent += row + "\n";
        });

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `inventario_${new Date().toISOString().split('T')[0]}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        this.showToast('Inventario exportado a Excel correctamente', 'success');
    }

    exportToPDF() {
        // This would require a PDF library like jsPDF
        // For now, we'll create a printable version
        window.print();
        this.showToast('Preparando documento para impresi√≥n PDF...', 'info');
    }

    printReport() {
        window.print();
        this.showToast('Preparando documento para impresi√≥n...', 'info');
    }

    showToast(message, type = 'info') {
        const toastContainer = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        
        const icons = {
            success: 'fas fa-check-circle',
            error: 'fas fa-exclamation-circle',
            warning: 'fas fa-exclamation-triangle',
            info: 'fas fa-info-circle'
        };
        
        toast.innerHTML = `
            <i class="${icons[type]}"></i>
            <span>${message}</span>
        `;
        
        toastContainer.appendChild(toast);
        
        setTimeout(() => {
            toast.remove();
        }, 3000);
    }
}

// Initialize the inventory manager when DOM is loaded
let inventoryManager;
document.addEventListener('DOMContentLoaded', () => {
    inventoryManager = new InventoryManager();
});
